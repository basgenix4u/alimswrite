// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== ADMIN USER ====================
model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== SITE SETTINGS ====================
model SiteSettings {
  id              String   @id @default("main")
  siteName        String   @default("AlimsWrite")
  tagline         String   @default("Your Academic Writing Partner")
  logo            String?
  favicon         String?
  
  // Contact
  whatsappNumber  String   @default("09039611238")
  email           String?
  phone           String?
  address         String?
  
  // Social Media
  facebook        String?
  twitter         String?
  instagram       String?
  linkedin        String?
  youtube         String?
  tiktok          String?
  
  // SEO
  metaTitle       String   @default("AlimsWrite - Professional Academic Writing Services in Nigeria")
  metaDescription String   @default("Get quality project writing, thesis, dissertation, data analysis, and research services. Trusted by students across Nigerian universities.")
  metaKeywords    String?
  ogImage         String?
  googleAnalytics String?
  
  // Appearance
  primaryColor    String   @default("#1E3A8A")
  secondaryColor  String   @default("#F59E0B")
  accentColor     String   @default("#3B82F6")
  
  // Chat Settings
  chatTimeout     Int      @default(60) // seconds before showing WhatsApp fallback
  chatEnabled     Boolean  @default(true)
  popupEnabled    Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==================== FACULTIES & DEPARTMENTS ====================
model Faculty {
  id          String       @id @default(cuid())
  name        String       @unique
  slug        String       @unique
  icon        String?
  description String?
  order       Int          @default(0)
  isActive    Boolean      @default(true)
  departments Department[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Department {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  aliases     String[] // Alternative names for fuzzy matching
  description String?
  icon        String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  
  facultyId   String
  faculty     Faculty  @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  
  topics      Topic[]
  orders      Order[]
  callbacks   CallbackRequest[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([facultyId])
}

// ==================== TOPICS (Project Topics Bank) ====================
model Topic {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  description     String?  @db.Text
  abstract        String?  @db.Text
  objectives      String[] // List of objectives
  methodology     String?
  keywords        String[] // For SEO and search
  
  // Classification
  departmentId    String
  department      Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  level           String   @default("BSc") // BSc, MSc, PhD, HND, ND, NCE
  year            Int      @default(2024)
  chapters        Int      @default(5)
  pages           Int?
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  // Stats
  views           Int      @default(0)
  orders          Int      @default(0)
  
  // Status
  isFeatured      Boolean  @default(false)
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([departmentId])
  @@index([slug])
}

// ==================== SERVICES ====================
model Service {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  shortDesc   String   // Short description for cards
  description String   @db.Text // Full description
  icon        String?  // Icon name or URL
  image       String?
  features    String[] // List of features
  
  // Pricing (optional, for display only)
  startingPrice String?
  priceNote     String?
  
  order       Int      @default(0)
  isFeatured  Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  orders      Order[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== ORDERS (Lead Capture) ====================
model Order {
  id              String   @id @default(cuid())
  orderNumber     String   @unique
  
  // Customer Info
  customerName    String
  customerEmail   String
  customerPhone   String
  customerWhatsapp String
  
  // Project Details
  serviceId       String?
  service         Service? @relation(fields: [serviceId], references: [id])
  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])
  
  projectTitle    String?
  projectType     String   // Project, Thesis, Assignment, etc.
  level           String?  // BSc, MSc, PhD, etc.
  numberOfPages   Int?
  numberOfChapters Int?
  deadline        DateTime?
  
  description     String   @db.Text
  attachments     String[] // File URLs
  
  // Status
  status          String   @default("pending") // pending, contacted, in_progress, completed, cancelled
  priority        String   @default("normal") // low, normal, high, urgent
  
  // Admin Notes
  adminNotes      String?  @db.Text
  assignedTo      String?
  quotedPrice     String?
  
  // Source
  source          String   @default("website") // website, whatsapp, popup, chat
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// ==================== CALLBACK REQUESTS ====================
model CallbackRequest {
  id           String   @id @default(cuid())
  
  name         String
  phone        String
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  departmentText String? // If they typed a custom department
  
  serviceNeeded String?
  description   String?  @db.Text
  
  source        String   @default("popup") // popup, chat, form
  
  status        String   @default("pending") // pending, called, no_answer, completed
  adminNotes    String?
  calledAt      DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
}

// ==================== BLOG ====================
model BlogCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  
  posts       BlogPost[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BlogPost {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  excerpt         String   @db.Text // Short preview
  content         String   @db.Text // Full content (HTML)
  
  featuredImage   String?
  images          String[] // Additional images
  
  categoryId      String
  category        BlogCategory @relation(fields: [categoryId], references: [id])
  
  tags            String[]
  keywords        String[] // SEO keywords
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  // Stats
  views           Int      @default(0)
  
  // Publishing
  status          String   @default("draft") // draft, published, archived
  publishedAt     DateTime?
  
  isFeatured      Boolean  @default(false)
  allowComments   Boolean  @default(true)
  
  comments        Comment[]
  
  authorName      String   @default("AlimsWrite Team")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([categoryId])
  @@index([slug])
  @@index([status])
}

model Comment {
  id          String   @id @default(cuid())
  
  postId      String
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  authorName  String
  authorEmail String
  content     String   @db.Text
  
  // Reply to another comment
  parentId    String?
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentReplies")
  
  status      String   @default("pending") // pending, approved, rejected, spam
  
  adminReply  String?  @db.Text // Your reply as admin
  repliedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([postId])
  @@index([status])
}

// ==================== TESTIMONIALS & REVIEWS ====================
model Testimonial {
  id            String   @id @default(cuid())
  
  // Customer Info
  customerName  String
  customerEmail String?
  customerPhone String?
  university    String?
  department    String?
  
  // Review Content
  content       String   @db.Text
  rating        Int      @default(5) // 1-5 stars
  
  // Project Info
  serviceUsed   String?
  projectType   String?
  
  // Media
  image         String?  // Customer photo or screenshot
  isImageTestimonial Boolean @default(false) // If it's a WhatsApp screenshot
  
  // Status
  status        String   @default("pending") // pending, approved, rejected
  isFeatured    Boolean  @default(false)
  
  // Source
  source        String   @default("website") // website, admin_added, whatsapp
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
}

// ==================== CHAT & MESSAGES ====================
model ChatSession {
  id           String   @id @default(cuid())
  
  visitorId    String   // Browser fingerprint or session ID
  visitorName  String?
  visitorEmail String?
  visitorPhone String?
  
  messages     ChatMessage[]
  
  status       String   @default("active") // active, waiting, closed
  
  // If converted to callback
  callbackRequested Boolean @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([visitorId])
  @@index([status])
}

model ChatMessage {
  id          String   @id @default(cuid())
  
  sessionId   String
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  sender      String   // "visitor" or "admin" or "bot"
  message     String   @db.Text
  
  // New fields for file/voice messages
  messageType String   @default("text") // "text", "image", "file", "voice"
  fileUrl     String?
  fileName    String?
  fileDuration Int?    // Duration in seconds for voice messages
  
  isRead      Boolean  @default(false)
  
  createdAt   DateTime @default(now())

  @@index([sessionId])
}

// ==================== FAQ ====================
model FAQ {
  id       String   @id @default(cuid())
  question String
  answer   String   @db.Text
  category String?
  order    Int      @default(0)
  isActive Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== ANALYTICS (Simple) ====================
model PageView {
  id        String   @id @default(cuid())
  path      String
  referrer  String?
  userAgent String?
  ip        String?
  country   String?
  
  createdAt DateTime @default(now())

  @@index([path])
  @@index([createdAt])
}

// ==================== NOTIFICATIONS ====================
model Notification {
  id        String   @id @default(cuid())
  type      String   // order, comment, review, callback, chat
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())

  @@index([isRead])
  @@index([createdAt])
}